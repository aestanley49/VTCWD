---
title: "Surveillance Handout Workshop"
output: word_document
date: "2024-1-24"
---

Notes: Outstanding Qs/Issues
- final graph
- How to address cost information
- Whether we get data from VT
- Need to make theme/look of handout consistent 
- Figure caption comments x2
- Last 2 figures redundant? 

reframe
here is relationship at any unit of interest 
start at what we could do at county level 
here is what we can do with county data
here is what happens when we scale up at the state level
copy back to state level (first graph again with information)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup2, include=FALSE}
### ### Load libraries 
library(tidyverse)
library(readxl)
library(knitcitations)
library(kableExtra) ## devtools::install_github("kupietz/kableExtra") #some issue needed patching
library(flextable) #kable doesn't knit to word
library(directlabels) # To add labels to lines in ggplot

### ### Read in data
countytbl <- read_excel("Tablesfrom2022DeerHarvestReport.xlsx", sheet = "Table012")
PercentSeason <- read_excel("Tablesfrom2022DeerHarvestReport.xlsx", sheet = "PercentSeason")

### ### Initial cleaning
# Drop extra columns from dataframe 
countytbl <- countytbl %>% dplyr::select(-Total, -HarvestperSqMile)
countytbl_long <- countytbl %>% 
  pivot_longer(cols = !c(County, Town), names_to = "Season", values_to = "Count", values_drop_na = T)

# join percents to main df by Season
fulldf <- countytbl_long %>% full_join(PercentSeason, by = "Season")

## Assume have 1/3 of total from riffle season 
fulldf <- fulldf %>% 
  mutate(Count = case_when(Season == "Regular" ~ Count*1/3, Season != "Regular" ~ Count))

set.seed(123)
fulldf <- fulldf %>%
  add_column(AdultBuckCount = NA, AdultDoeCount = NA, MaleFawnCount = NA, FemaleFawnCount = NA)
for(i in 1:nrow(fulldf)){
  fulldf[i, 9:12] <- t(rmultinom(1, as.numeric(fulldf[i,4]) , prob = fulldf[i,5:8]))
}
```

### The relationship between prevalence, confidence, and number of samples


The graph below shows the number of samples required to have a 90%, 95%, or 99% confidence (see colored lines) in detecting *at least one* case of chronic wasting disease, under various assumed prevalences (x-axis). Prevalence refers to the proportion of the population that is diseased.


```{r genDFs, include= FALSE}
## From this, create 2 different data sets: (aggregated at county level but could do other boundaries)
# 1) All harvested indiviudals
# 2) All sampled inidividuals (just youth and open riffle (which is regular here??))


## Cost points for each sample
# low - Indiana - 16/sample
# High own lab - MI - 189/sample
# High no lab - Ohio - 200/sample

Indiv_county_ALL <- fulldf %>% 
  group_by(County) %>% 
  summarise(AdultBuckCount = sum(AdultBuckCount), 
            AdultDoeCount = sum(AdultDoeCount),
            MaleFawnCount = sum(MaleFawnCount),
            FemaleFawnCount = sum(FemaleFawnCount)) %>% 
  rowwise() %>%
  mutate(ContyTotal = sum(AdultBuckCount, AdultDoeCount, MaleFawnCount, FemaleFawnCount)) %>% 
  mutate(Indiana = 16) %>% 
  mutate(Michigan = 189) %>% 
  mutate(Ohio = 200)

Indiv_county_CheckStations <- fulldf %>% 
  filter(Season == "Youth" | Season == "Regular") %>% 
  group_by(County) %>% 
  summarise(AdultBuckCount = sum(AdultBuckCount), 
            AdultDoeCount = sum(AdultDoeCount),
            MaleFawnCount = sum(MaleFawnCount),
            FemaleFawnCount = sum(FemaleFawnCount)) %>% 
  rowwise() %>%
  mutate(ContyTotal = sum(AdultBuckCount, AdultDoeCount, MaleFawnCount, FemaleFawnCount)) %>% 
  mutate(Indiana = 16) %>% 
  mutate(Michigan = 189) %>% 
  mutate(Ohio = 200)
```

<br>
```{r statewide table, echo=FALSE}
State_ALL <- sum(Indiv_county_ALL$ContyTotal)
State_CheckStations <- sum(Indiv_county_CheckStations$ContyTotal)

SRSno.sampleCalcfunc <- function(prevalence = .01, confidence = .99){
  log(-(confidence - 1))/(log(1 - prevalence))
}

### Create vectors of alpha and prevalence 
#vecalpha <- c(seq(.01, .1, by = .001)) # Change this to select 4 values of alpha that we care about
vecalpha <- c(.01, .05, .1, .2) #99, 95, 90, 80
#vecprev <- c(.001, .01, .1)
vecprev <- c(seq(.01, .1, by = .0001))

All_NoSampSRS <- data.frame()
setcounter <- 1
for(i in vecalpha){
  for(j in vecprev){
    HoldNo <- SRSno.sampleCalcfunc(prevalence = j, confidence = 1 - i)
    IDCharString <- paste0("Alpha_", i, "_", "Prevalence_", j)
    ## Create counter that depends on i & j
    setcounter
    All_NoSampSRS[setcounter, 1] <- IDCharString
    All_NoSampSRS[setcounter, 2] <- HoldNo
    setcounter <- setcounter + 1
  }
}

colnames(All_NoSampSRS) <- c("Surveillance Design", "No. Samples Needed")
All_NoSampSRS$'No. Samples from Check Stations' <- rep(State_CheckStations, nrow(All_NoSampSRS))
All_NoSampSRS$'No. Samples from All Harvest' <- rep(State_ALL, nrow(All_NoSampSRS))
```

```{r, fig.cap="Figure 1. No. Samples Needed under Different Surveillance Designs", echo = F, message=FALSE, fig.width=10, fig.height=7}
All_NoSampSRS_grph_setup <- All_NoSampSRS %>%
  separate_wider_delim(cols = `Surveillance Design`, delim = "_", names = c("alpha_label", "Alpha", "prev_label", "Prevalence")) %>% 
  mutate(Confidence = 1- as.numeric(Alpha)) # Create Confidence
All_NoSampSRS_grph_setup$Prevalence <- as.numeric(All_NoSampSRS_grph_setup$Prevalence)

#ggplot(All_NoSampSRS_grph_setup) + 
#  geom_point(aes(x = Prevalence, y = `No. Samples Needed`, color = Alpha))


## add horizontal line for avg number of checked deer per strata 
ABC <- sum(Indiv_county_CheckStations$AdultBuckCount)
ADC <- sum(Indiv_county_CheckStations$AdultDoeCount)
MFC <- sum(Indiv_county_CheckStations$MaleFawnCount)
FFC <- sum(Indiv_county_CheckStations$FemaleFawnCount)

#create data frame that contains horizontal line location
cutoff <- data.frame(yintercept=ADC, Lines='Adult Doe Count')
cutoff2 <- data.frame(yintercept=MFC, Lines='Male Fawn Count')
cutoff3 <- data.frame(yintercept=FFC, Lines='Female Fawn Count')


ggplot(All_NoSampSRS_grph_setup) + 
  geom_point(aes(x = Prevalence, y = `No. Samples Needed`, color = as.factor(Confidence) ) ) +
  scale_y_continuous(breaks=seq(0, 500,20), limits = c(0, 500) ,
    sec.axis = sec_axis(~ . * 189, name = "Cost (Michigan - 189$/sample)\n") #\n adds line break or space
  ) + 
  #scale_x_continuous(breaks=seq(0, 1, .01)) +
  labs(color = "Confidence") + 
  geom_hline(aes(yintercept=yintercept, linetype=Lines), cutoff, color = "blue") +
  geom_hline(aes(yintercept=yintercept, linetype=Lines), cutoff2, color = "darkgreen") +
  geom_hline(aes(yintercept=yintercept, linetype=Lines), cutoff3, color = "darkblue") + 
  labs(caption = "Note: Adult Buck Count totals 2688 and is not included on the graph") + 
  theme(axis.text=element_text(size=14, colour="black"),
        axis.title=element_text(size=16,colour="black"),
        legend.text=element_text(size=12), 
        panel.background = element_rect(fill = "white", colour = "grey50"))



```
*!!!!!!! not about particular unit (county/state) but general statistical relationship 
*** Double check the proportion coming from VT check data (assume small proportion) --> biocheck 10% (or less) of the regular season harvest

<br>
<br>

### For a given state wide prevalence level, what is the achieved county-level prevalence given all estimated checked animals?

*If we get data from Vermont:*
As an example of what could be achieved using biological check stations for data collection, we use data from the 2022 Vermont harvest. Each harvested individual is classified into a strata (adult male, adult female, yearling male, and yearling female), season (first weekend of regular or youth hunt), and wildlife management unit (WMU).  

*If we don't get data from Vermont and use simulated data:*
We use values from the Vermont 2022 Deer Harvest report to estimate counts of individuals in strata (adult male, adult female, yearling male, and yearling female), harvested in Vermontâ€™s 14 counties, across harvest seasons (archery, youth, novice, October muzzle, regular, and December muzzle). We use an multinomial with probability informed by percentage breakdowns in the deer harvest report to estimate the count of each strata in a county by season. Vermont only collects samples from check stations from the first weekend of the regular season and from the youth hunt. We estimate that checked individuals from the regular season were only 1/3 of the total harvest. Our dataset only includes individuals harvested in the youth hunt and one-third of individuals harvested in the regular season. 
<br>

With these data, we calculate the number of samples needed to detect CWD at a given prevalence and statistical assurance (alpha). Alpha is the confidence that population-level CWD prevalence is at or below the threshold level. 


Under a simplified random sample (SRS), the confidence level heavily influences the number of samples needed and associated costs. 

Here, we divide the total number of samples needed for specific combinations of state-level confidence and prevalence proportionally by WMU and then identify whether the number of samples available at a WMU level through biological check stations is enough to meet the proportional allocation. The proportional number of samples needed per WMU is based on the proportion of the total harvest generated by that WMU. 


```{r, echo=FALSE, message = F, warning = F, fig.cap="Figure 2. Resulting Prevalence at County Level", fig.width=10, fig.height=11}
SRS_for_dfs_func <- function(Indiv_county_ALL){

  Indiv_county_ALL_SRS <- Indiv_county_ALL %>% 
      #Figure out proportional harvest per country 
  mutate(prop = ContyTotal/(sum(Indiv_county_ALL$ContyTotal)))
    
  ### Create vectors of alpha and prevalence 
vecalpha <- c(.01, .05, .1, .2) #99, 95, 90, 80
vecprev <- c(seq(.01, .1, by = .0001))

## Do alpha 
Acolfunc <- function(df, n){
      varname <- paste0("alpha.", n)
      df %>%
         mutate(!!varname := 1 * n) ### Fining a way to add row of the same value 
}
Indiv_county_ALL_alph <- Indiv_county_ALL_SRS
for(i in vecalpha){
    Indiv_county_ALL_alph <- Acolfunc(df = Indiv_county_ALL_alph, n = i)
}
Indiv_county_ALL_alph <- Indiv_county_ALL_alph %>% pivot_longer(cols = starts_with("alpha"),
             names_to = "Alpha", values_to = "Alpha_level")
             

## Set up prev 
Prevcolfunc <- function(df, n){
      varname <- paste0("Prevalence", n)
      df %>%
         mutate(!!varname := 1 * n)
}
Indiv_county_ALL_Prev <- Indiv_county_ALL_SRS
for(i in vecprev){
    Indiv_county_ALL_Prev <- Prevcolfunc(df = Indiv_county_ALL_Prev, n = i)
}
Indiv_county_ALL_Prev <- Indiv_county_ALL_Prev %>% pivot_longer(cols = starts_with("Prevalence"),
             names_to = "Prevalence", values_to = "Prevalence_level")

LongAlph_Prev <- Indiv_county_ALL_Prev %>% full_join(Indiv_county_ALL_alph, 
  by = c("County","AdultBuckCount","AdultDoeCount","MaleFawnCount","FemaleFawnCount",
         "ContyTotal","Indiana","Michigan","Ohio", "prop"))


Indiv_county_ALL_SRS <- LongAlph_Prev %>% 
  ### Now calc number of samples needed 
  mutate(NoSamples = log(-((1-Alpha_level) - 1))/(log(1 - Prevalence_level))) %>% 
  mutate(NoSamplesperCounty = NoSamples*prop) %>% #mult by proportion of harvest
  ## Now calculate costs
  mutate(Cost_Indiana = NoSamplesperCounty *Indiana) %>% 
  mutate(Cost_Michigan = NoSamplesperCounty *Michigan) %>% 
  mutate(Cost_Ohio = NoSamplesperCounty *Ohio) %>% 
  ## Do we have enough samples in the county (Y/N)
  mutate(TargetMeet = if_else((NoSamplesperCounty - ContyTotal)  > 0, "False", "True"))
}

Indiv_county_CheckStations_SRS <- SRS_for_dfs_func(Indiv_county_CheckStations)

#ggplot(Indiv_county_CheckStations_SRS) + 
#  geom_point(aes(x = Prevalence_level, y = NoSamplesperCounty, color = TargetMeet))+
#  facet_wrap(~County) + 
#   labs(x = "Prevalence", y = "No. Samples per County") 

## Old graph to see if could meet target, not informative when it's all true... 

Indiv_county_CheckStations_SRS <- Indiv_county_CheckStations_SRS %>% 
  mutate(county_prev = 1- (Alpha_level^(1/NoSamplesperCounty))) %>% 
  mutate(Confidence_num = (1 - Alpha_level) *100) %>%  #create confidence label
  mutate(Confidence = paste0(Confidence_num, "%", " confidence")) %>% 
  mutate(line_names = as.character(round(prop,2)))

ggplot(Indiv_county_CheckStations_SRS) + 
  geom_point(aes(x = Prevalence_level, y = county_prev, color = County))+
 # facet_wrap(~Confidence) + 
   labs(x = "State Wide Prevelance", y = "County Level Prevelence Achieved") + 
  scale_y_continuous(expand=c(0, .105))+
  geom_dl(aes(x = Prevalence_level, y = county_prev,label = line_names), method = list("last.points", cex=.8, hjust=1.2) ) +
  labs(caption = "Note: The proportion of harvest per county is given in the text")  

```

The smaller the proportion of harvest is for a county, the less power that county has to detect CWD and higher the resulting county-level prevalence will be for a given state prevalence level.


*Note, this doesn't change with alpha, does that make sense?*
scrap work to check this...
```{r}
prop <- c(.7, .2, .1)
Setpre <- c(.01, .1)
setalpha <- c(.1, .05)
#NoSamples = log(-((1-Alpha_level) - 1))/(log(1 - Prevalence_level))
NoSamples.1 = log(-((1-.1) - 1))/(log(1 - .01))
count1a <- NoSamples.1*.7
NoSamples.05 = log(-((1-.05) - 1))/(log(1 - .01))
count1b <- NoSamples.05*.7

#EstPrev = 1 - (Alpha_level)^(1/NoSamplesperCounty)
EstPreva = 1 - (.1)^(1/count1a)

EstPrevb = 1 - (.05)^(1/count1b)

print(EstPreva)
print(EstPrevb)
```




### Estimating our power to detect CWD across counties using all available samples

For each county, we can take the prevalence where we would have the power to detect CWD at least once for a given confidence. 
```{r, echo=FALSE, fig.cap="Figure 3. Prevalence Level from Available Samples per County"}
Prev_Indiv_county_CheckStations <- Indiv_county_CheckStations %>% 
  mutate(Alpha_01 = .01) %>% 
  mutate(Alpha_05 = .05) %>% 
  mutate(Alpha_1 = .1) %>% 
  pivot_longer(cols = c("Alpha_01", "Alpha_05", "Alpha_1"), 
               names_to = "Alpha", values_to = "Alpha_level") %>% 
  ### Now calc prev from number of samples 
  # extra step to make sure not too wonky 
  mutate(confidencecalc = 1 - Alpha_level) %>% 
  mutate(EstPrev = 1 - (Alpha_level)^(1/ContyTotal) )

### How are prevalence values still so high? 

## Set up table
Prev_Indiv_county_CheckStations_tbl <- Prev_Indiv_county_CheckStations %>% 
  select(County, ContyTotal, confidencecalc, EstPrev )

#colnames(Prev_Indiv_county_CheckStations_tbl) <- c("County", "No. Samples", "Confidence Level", "Prevalence")

#kable(Prev_Indiv_county_CheckStations_tbl,
#      caption = "Table 9. Total Prevalence that for a Set Level of Alpha Given the Total Number of Samples #in a County for the Check Stations Dataset",
#      align = "lrrr") %>% 
#  kable_styling(bootstrap_options = "striped")

# The palette with grey:
cbPalette <- c("#999999", "#56B4E9", "#009E73")


ggplot(Prev_Indiv_county_CheckStations_tbl) + 
  geom_point(aes(x = EstPrev, y = factor(County), color = factor(confidencecalc))) + 
  labs(x = "County Level Prevalence", y = "County", color = "Confidence Level") + 
  scale_color_brewer(palette = "Dark2")

```

### Costs

Costs of surveillance vary with the scale of the surveillance program, whether hunters or others (e.g., VFWD staff, processors) are collecting the samples, and where the laboratory analyses are completed. Estimates of cost per sample range from $10/sample (current Vermont costs for low sample sizes) to $188/sample (estimate from Michigan which has a large, staff-based surveillance program).

### next figure...
Set prevalence level want to detect at county level and then add number of samples need up..  
*This will be Figure 1 with 14 times the y-axis*
```{r}

```

